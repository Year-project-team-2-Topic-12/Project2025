# ML-service
- [ML-service](#ml-service)
  - [Реализовано:](#реализовано)
  - [Структура:](#структура)
  - [Тестирование (запуск приложения):](#тестирование-запуск-приложения)
    - [Требования к системе](#требования-к-системе)
  - [Эндпоинты](#эндпоинты)
  - [Фронтенд](#фронтенд)
  - [Авторизация](#авторизация)

## Реализовано:

- Сохранение API-запросов к модели (`/forward`, `/forwardMultiple`) в базу данных.
- Просмотр истории запросов через `GET /history`.
- Удаление всей истории через `DELETE /history` (нужны права admin).
- Механизм Alembic-миграций для управления структурой БД.
- Статистика по успешным запросам (среднее время, квантили, размеры изображений) через `GET /stats`.
- Простой фронтенд для доступа к сервису.
- Автогенерация Postman-коллекции и клиентских интерфейсов для работы с API.
- Безопасный вход в систему с выдачей токенов.
- Использование bcrypt (passlib) для безопасного хранения паролей.
- Разделение ролей на Admin (полные права) и User (инференс и история).
- Middleware-защита, которая проверяет токены до попадания запроса в роутеры.

## Структура:
```text
service/
├── alembic/               # миграции БД
├── alembic.ini            # конфиг Alembic
├── logs/                  # логи сервиса
├── service_db.db          # SQLite база (создается при работе)
├── README.md
└── src/
    ├── backend/
    │   ├── main.py        # FastAPI app, регистрация роутеров и middleware
    │   ├── deps.py        # DI + кэшированные инстансы предикторов
    │   ├── init_admin.py  # ручная инициализация администратора
    │   ├── database.py    # реэкспорт engine
    │   ├── security.py    # auth утилиты (реэкспорт)
    │   ├── db/            # подключение и репозитории
    │   │   ├── connection.py
    │   │   ├── models.py
    │   │   └── repositories/
    │   │       ├── request_log_repository.py
    │   │       └── user_repository.py
    │   ├── routers/       # auth/history/stats/inference
    │   ├── schemas/       # Pydantic-схемы
    │   └── services/      # бизнес-логика (auth, inference, stats, logging)
    └── ml/ -> ../../packages/ml/src
        ├── hog_predictor.py
        ├── preprocessing.py
        ├── hog.py
        └── ...
```

## Тестирование (запуск приложения):
### Требования к системе
```
linux
node js >=24
curl >= 8
python >= 3.13
```
* Используйте скрипт автоматизации для установки всех зависимостей (включая библиотеки для безопасности):
```text
./bootstrap.sh
# Выберите пункт 4 (Install ALL deps)
```

* Примените миграции Alembic (создаст файл базы данных):
```text
./bootstrap.sh
# Выберите пункт 6 (Alembic upgrade head)
```


* Запуск приложения
```text
./bootstrap.sh
# Выберите пункт 5 (Run backend)
```
Backend доступен по адресу `http://127.0.0.1:8000`, документация: `http://127.0.0.1:8000/docs`.

* Запуск фронтенда (в отдельном терминале)
```text
./bootstrap.sh
# Выберите пункт 8 (Run frontend)
```
Frontend доступен по адресу `http://localhost:5173`.

Логи сохраняются в `service_db.db`.

## Эндпоинты
- `POST /auth/login`  
  Формат: `application/x-www-form-urlencoded`, поля `username`, `password`.  
  Ответ: `access_token`, `token_type`.  
  Использование: `Authorization: Bearer <token>` для защищенных (всех) роутов.

- `POST /auth/register`  
  Создание пользователя (только admin).  
  Формат: JSON с полями `username`, `password`.

- `GET /auth/users`  
  Список пользователей (только admin).

- `DELETE /auth/users/{username}`  
  Удаление пользователя (только для пользователей с ролью `admin`). Пользователя `admin` удалить нельзя.

- `POST /forward`  
  Инференс по одному изображению.  
  Формат: `multipart/form-data`, поле `image` (файл).  
  Заголовок `X-Debug: true` включает `debug` в ответе (обработанное изображение и HOG).

- `POST /forwardMultiple`  
  Инференс по нескольким исследованиям.  
  Формат: `multipart/form-data`, повторяющиеся поля `images` (файлы).  
  Заголовок `X-Study-Ids` обязателен: список ID через запятую, количество ID должно совпадать с количеством файлов.  
  Опционально `X-Debug: true` (с той же семантикой).

- `GET /history`  
  История инференсов из БД (требуется токен). Возвращает метаданные, время, статус и результат.

- `DELETE /history`  
  Полная очистка истории (только admin).

- `GET /stats`  
  Статистика по успешным запросам: среднее время, p50/p95/p99 и средние размеры изображений.

## Фронтенд
**Прокси Vite**
Во время разработки фронтенд проксирует запросы на backend по путям `/auth`, `/forward`, `/forwardMultiple`, `/history`, `/stats`.
Настройки находятся в `frontend/vite.config.ts`.

**Дополнительные фичи**
- Автосоздание администратора при старте сервиса (пароль берется из `ADMIN_PASSWORD`).
- Debug-режим инференса через `X-Debug: true` (в ответе появляются обработанные изображения и HOG).
- Построение Postman-коллекции из OpenAPI и автоматический патчинг (папка `postman/`).

**Alembic:**
При внесении изменений в `models.py` позволяет обновить структуру базы данных одной командой.
* Создание новой миграции
```text
alembic revision --autogenerate -m "change message"
```
* Применение новой миграции
```text
alembic upgrade head
```
(для изменений сверху просто используйте соответствующий пункт в меню `bootstrap.sh`)

## Авторизация
**Как работает авторизация**
В проекте реализован AuthMiddleware (находится в `security.py`), который перехватывает каждый входящий запрос:

Открытые пути: `/auth/login`, `/docs`, `/openapi.json` доступны без токена.

Проверка токена: для всех остальных путей проверяется заголовок `Authorization: Bearer <token>`.

Контроль ролей: если пользователь пытается выполнить `DELETE /history`, middleware проверяет роль на администратора (в базе данных).
Если роль `user`, возвращается ошибка 403 Forbidden.

**Пример авторизации**
1. Получение токена: отправьте `POST /auth/login` с логином и паролем. В ответ вы получите `access_token`.
2. Авторизация в Swagger: нажмите кнопку Authorize на `/docs` и вставьте полученный токен.
3. Защищенный запрос: теперь при вызове `/history` сервер проверит роль и разрешит (или запретит) действие.
